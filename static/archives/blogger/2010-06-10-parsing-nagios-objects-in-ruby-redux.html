--- 
name: parsing-nagios-objects-in-ruby-redux
layout: post
title: Parsing Nagios Objects in Ruby Redux
time: 2010-06-10 01:36:00 -04:00
---
When I was with MediaOcean, one of the projects I was working on was a stack of ruby code for parsing/writing nagios configs. This was in parallel with setting up puppet. I actually got pretty far along but then DDS had a RIF and I was back on the market.<p>I had to put the code aside and just recently pulled it out again. Some/most of it is pretty ugly. I had quite a bit done though.</p>So here I am "refactoring" (and I use that term VERY VERY loosely) the code base. So I'm happily parsing away - iterating over the cfg_file/cfg_dir entries and build a nice big hash to hold all the object definitions. I dump it to a YAML file for validation when I notice this nice bit of junk in my timeperiod dump:<div><br /></div><div><script src="http://gist.github.com/433057.js"></script></div><div><br />Oh yeah...that looks right =/<br /><div><br /></div><div>For those who don't know, nagios object definitions are pretty straightforward. Here's an example:</div><div><br /></div><div><script src="http://gist.github.com/433060.js"></script></div><div><br /></div><div>Easy enough to parse, right? Object type named (<i>host)</i>. A clear beginning and end denoted by curly braces. Object attributes in a seemingly key/value type markup. Some people smash the opening brace up against the object type definition but that's easily caught.</div><div><br /></div><div>Iterating over the definition in Ruby is pretty straightforward (assuming a perfect example):</div><div><br /></div><div><script src="http://gist.github.com/433050.js"></script></div><div><br /></div>What becomes a problem is timeperiod defintions. The syntax for those is somewhat complicated. Looking back at the YAML fragment above, you can see why. For timeperiods, while the rightmost value is the actual time frame, the left part (usually a day of the week) can actually be a specific day. So if I wanted to create an entry for Christmas in the U.S., I would define it like so:<br /><code><br />december 25 00:00-00:00<br /></code><br /><div>Things can be even MORE complicated if I wanted to handle non-date holidays:</div><div><span class="Apple-style-span"   style="font-family:monospace;font-size:100%;"><span class="Apple-style-span"  style="font-size:13px;"><span class="Apple-style-span"   style="font-family:Georgia, serif;font-size:130%;"><span class="Apple-style-span"  style="font-size:16px;"><br /></span></span></span></span></div><code>monday 1 september      00:00-00:00     ; Labor Day (first Monday in September)<br />thursday -1 november    00:00-00:00     ; Thanksgiving (last Thursday in November)<br /></code><br /><div>Ugly, no?<b> </b>I searched high and low for the ability to split starting from the right and didn't find anything native. I had to resort to implementing my own rsplit method for String:</div><div><br /></div><div><script src="http://gist.github.com/433064.js"></script></div><div><br /></div><div>It works but I also can't use it across the board. If I do, I break things that were working (<i>alias, service_description</i>) that can have a space in the value.</div><div><br /></div><div>I'm not even going to get into trying to convert timeperiod definitions into Date objects yet. That gives me cold sweats.</div></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/934985301455705990-2095218944462311233?l=lusislog.blogspot.com' alt='' /></div>
