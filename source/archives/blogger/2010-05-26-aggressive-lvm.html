--- 
name: aggressive-lvm
layout: post
title: Aggressive LVM
time: 2010-05-26 16:14:00 -04:00
---
So I ran into an interesting issue that I hadn't seen in quite some time.  I've got a server running KVM. I use the Virtio driver and logical volumes to hold the OS and Data disks for each VM. <div><br /></div><div>Every time I used the lvm tools on the hypervisor, I was seeing random vgs, pvs and lvs. It took me a second to noodle out the problem.</div><div><br /></div><div>LVM was picking up the guest volume groups and activating them. For instance, many of my VMs have a data volume. Those were getting picked up and activated OUTSIDE of the vm because of the LVM scanning filter.</div><div><br /></div><div>I know at one point, the default filter only scanned <i>hd.*</i> and <i>sd.*</i> as valid block devices but it looks like the default filter is now:</div><div><br /></div><div><code>filter = [ "a/.*/" ]</code></div><div><br /></div><div>which makes everything in <i>/dev</i> a valid target for scanning and activating.</div><div><br /></div><div>Being that this particular box is 1U with a single hardware raid array, I knew that the only valid block devices would be <i>/dev/sd</i>.</div><div><br /></div><div>I changed the filter line to this:</div><div><br /></div><div><code>filter = [ "a|/dev/sd.*|", "r/.*/" ]</code></div><div><br /></div><div>A quick vgscan -vvvv showed me that my guest volumes were no longer valid targets:</div><div><br /></div><code><div>#filters/filter-regex.c:172         /dev/ajc-dd-dmzvirt1/isolv: Skipping (regex)</div><div>#label/label.c:160       /dev/sda5: lvm2 label detected</div><div>#filters/filter-regex.c:172         /dev/ajc-dd-dmzvirt1/vdisk-itgweb1: Skipping (regex)</div></code><div></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/934985301455705990-8757249318909703986?l=lusislog.blogspot.com' alt='' /></div>
