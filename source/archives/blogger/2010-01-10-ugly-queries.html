--- 
name: ugly-queries
layout: post
title: Ugly queries
time: 2010-01-10 23:16:00 -05:00
---
I've never been a fan of ORMs in general. I love the concept. I think it's awesome but since the early days of hibernate, I've always had problems with automatically generated SQL statements. It's not as bad as it used to be but sometimes you get "gems" in the wild.<br /><br />Today's gem comes courtesy of the Geokit plugin for Rails. Our newest application at AJC uses Geokit for finding properties within a 10-mile radius of the entered address. We've got a table with about 500k rows of geocoded metro Atlanta property data in MySQL.<br /><br />Enter the query:<br /><br /><code><br />SELECT<br />*,<br />(ACOS(least(1,COS(0.593807786352424)<br />*COS(-1.47255067854929)<br />*COS(RADIANS(parcels.latitude))<br />*COS(RADIANS(parcels.longitude))+<br />COS(0.593807786352424)<br />*SIN(-1.47255067854929)<br />*COS(RADIANS(parcels.latitude))<br />*SIN(RADIANS(parcels.longitude))+<br />SIN(0.593807786352424)*SIN(RADIANS(parcels.latitude))))*3963.19)<br />AS distance FROM `parcels`   <br />WHERE (((parcels.latitude>32.5769814714641<br />AND parcels.latitude<35.4683785285359>-86.1150637195914<br />AND parcels.longitude<-82.6268142804086))<br />AND ((ACOS(least(1,COS(0.593807786352424)<br />*COS(-1.47255067854929)*COS(RADIANS(parcels.latitude))<br />*COS(RADIANS(parcels.longitude))+ COS(0.593807786352424)<br />*SIN(-1.47255067854929)<br />*COS(RADIANS(parcels.latitude))<br />*SIN(RADIANS(parcels.longitude))+<br />SIN(0.593807786352424)<br />*SIN(RADIANS(parcels.latitude))))*3963.19)<= 100))  <br />ORDER BY  distance asc <br />LIMIT 21; </code><br /><br />This bad boy is a DOOZY. It's got all the makings of exploiting everything in MySQL that can't be optimized - function results for comparison, ordering by function results and even a LIMIT thrown in for good measure.<br /><br />And guess what? There's currently not much that can be done to optimize this query. Indexes won't help. The query cache is useless because A) the queries are unique to each source address and B) it'll just get pushed out anyway.<br /><br />I'm looking around for some tips on this and the most likely solution is using spatial indexes in MySQL but that's a whole other issue.<div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/934985301455705990-5687764029156704410?l=lusislog.blogspot.com' alt='' /></div>
