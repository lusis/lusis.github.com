--- 
name: using-hudson-and-rvm-for-ruby-unit
layout: post
title: Using Hudson and RVM for Ruby unit testing
time: 2010-11-02 23:56:00 -04:00
---
<p>As with everything lately, something popped up on Twitter that prompted a blog post. In this case, @wakaleo was looking for any stories/examples for his Hudson book. I casually mentioned I could throw in some notes about how we use Hudson on the Padrino project.</p><p><span style="font-size: large;">Prerequisites</span></p><p>Here's what you'll need:</p><ul><li><a href="http://hudson-ci.org/" target="_blank">Hudson</a></li><li><a href="http://rvm.beginrescueend.com/" target="_blank">RVM</a></li><li><a href="http://wiki.hudson-ci.org/display/HUDSON/Ruby+metrics+plugin" target="_blank">Hudson Ruby Metrics plugin</a> (if you want code coverage reports)</li></ul><p>I'll leave you to get Hudson working. There are prebuilt packages for every distro under the sun. If you can't get past this step, you'll need to rethink a few things.</p><p><strong><span style="font-size: large;">Setting up RVM</span></strong></p><p>Once you have it installed, log in as your Hudson user and set up RVM.</p><p><em><strong>RVM Protip </strong>- If there are any gems (like say Bundler) that you ALWAYS install, edit </em><span style="font-family: 'andale mono', times;">.rvm/gemsets/default.gems</span><em> and </em><span style="font-family: 'andale mono', times;">.rvm/gemsets/global.gems</span><em> and add them there. In my examples, I did not do that.</em></p><p>You'll want to go ahead and install all the VMs you plan on testing against. We use 1.8.7, 1.9.1, 1.9.2, JRuby, RBX and REE:</p><p><span style="font-family: 'andale mono', times; font-size: x-small;">for i in 1.8.7 1.9.1 1.9.2 jruby ree rbx; do rvm install ${i}; done</span></p><p>This will take a while. When it's done, we can now dive into configuring our job in Hudson</p><p><strong><span style="font-size: large;">What is the Matrix?</span></strong></p><p>So you've got Hudson running and RVM all set up? Open the Hudson console and create a new job of type "<strong>Build multi-configuration project</strong>". From the job configuration screen, you'll want to set some basics - repository, scm polling and the like. The key to RVM comes under "<strong>Configuration Matrix</strong>"</p><p>&nbsp;</p><p>The way any user-defined variables work in Hudson, whether a build parameter or matrix configuration, is that you provide a "key" and then a value for that key. The value for that key is&nbsp;accessible&nbsp;to your build steps as a sigil variable. So if your key is <span style="font-family: 'andale mono', times;">my_funky_keyname_here</span>, you can reference <span style="font-family: 'andale mono', times;">$my_funky_keyname_here</span> in your build steps to get that value. With a configuration matrix, each permutation of the matrix provides the value for that key in the given permutation. So if I have:</p><p style="text-align: center;">foo as one axis with 6 values (1, 2, 3 ,4 ,5 ,6) and bar with 3 values (1, 2, 3)</p><p>each combination of foo and bar will be available to my build steps as $foo and $bar. The first run will have $foo as 1 and $bar as 1. Second run will have $foo as 2 and $bar as 1. On an on until the combinations are exhausted.</p><p>This makes for some REALLY powerful testing matrices. In our case, however, we only need one axis - <span style="font-family: 'andale mono', times;">rubyvm</span></p><p><em><strong>Hudson Protip -</strong> Don't get creative with your axis or parameter names. In our case, we'll be performing shell script steps. Don't call your axis "HOME" because that will just confuse things. Just don't do it.</em></p><p>So now we've added an axis called 'rubyvm' and provided it with values '1.8.7 1.9.1 1.9.2 jruby rbx ree'. As explained, this means that our build steps will iterate over each value of 'rubyvm' for us and repeat our build steps.</p><p><strong><span style="font-size: large;">Configuring your job</span></strong></p><p>Now that you've got your variables in place, you can write the steps for your job. This took me a little bit of time to work out the best flow. There were some things with how RVM operates with the shell that caught me off-guard initially (the rvm command being a function alias versus an executable). I've broken the test job into three steps:</p><ul><li>Create my gemset, install bundler and run bundle install/bundle check</li><li>Run my unit tests</li><li>Destroy my gemset</li></ul><p>In addition to taking advantage of the variable provided by the configuration matrix, we're also going to take advantage of some variables exposed by Hudson in a given job run - $BUILD_NUMBER. Using these two bits of information, we can build a gemset name for RVM that is unique to that run and that ruby vm.</p><p>Step 1:</p><p><p><span style="font-family: 'andale mono', times;">#!/bin/bash -l</span></p><p><span style="font-family: 'andale mono', times;">rvm use $rubyvm@padrino-$rubyvm-$BUILD_NUMBER --create</span></p><p><span style="font-family: 'andale mono', times;">gem install bundler</span></p><p><span style="font-family: 'andale mono', times;">bundle install</span></p><p><span style="font-family: 'andale mono', times;">bundle check</span></p><p>This uses the --create option of RVM to create our gemset. If our build number is 99 and our ruby vm is ree, we're creating a gemset called padrino-ree-97 for ree. Pretty straightforward.</p><p>Next we install bundler and then run the basic bundler tasks. All operations are performed in the workspace for your hudson project. This is typically the root directory of your SCM repository. If the root of your repo doesn't contain your Gemfile and Rakefile, you'll probably want to make your first step a 'cd' to that directory.</p><p>The reason for using a full shebang line is to make sure that RVM instantiates properly.</p><p>Step 2:</p><p><p><span style="font-family: 'andale mono', times;">#!/bin/bash -l</span></p><p><span style="font-family: 'andale mono', times;">rvm use $rubyvm@padrino-$rubyvm-$BUILD_NUMBER</span></p><p><span style="font-family: 'andale mono', times;">rake test</span></p><p>Each build step is a distinct shell session. For that reason we need to "use" the previously created gemset. Then we run our rake tasks.</p><p>Step 3:</p><p><p><span style="font-family: 'andale mono', times;">#!/bin/bash -l</span></p><p><span style="font-family: 'andale mono', times;">rvm use $rubyvm@global</span></p><p><span style="font-family: 'andale mono', times;">rvm --force gemset delete padrino-$rubyvm-$BUILD_NUMBER</span></p><p>This is the "cleanup" step. This cleans up our temporary gemsets that we created for the test run. My understanding was the each step was "independent". Should the middle step fail, the final step would still be executed. This doesn't appear to be the case anymore. For this reason, you'll probably want to occasionally go in and clean up gemsets from failed builds. If your build passes, the gemset will clean itself up. There's probably justification for some sort of "cleanup" job here but I haven't gotten around to trying to pass variables as artifacts to other build steps.</p><p>Now you can run the job and watch as Hudson gleefully executes your test cases against each ruby vm. How many of those run concurrently is dependent on how many workers you have configured globally in Hudson.</p><p><em><strong>Unit Testing Protip</strong> - One thing you'll find out early on is how concurrent your unit tests REALLY are. In the case of Padrino, ALL of our unit tests were using a hardcoded path (/tmp/sample_project) for testing. My first major step once I got added to the project was to refactor ALL of our tests to make that dynamic so that we could run more than one permutation at a time. You can see an example of how I did that <a href="https://github.com/padrino/padrino-framework/blob/master/padrino-gen/test/test_project_generator.rb" target="_blank">here</a>. Essentially I created an instance variable for our temp directory using UUID.new.generate. It was the quickest way to resolve the problem. If your tests aren't capable of running in parallel, that's one way to address it.</em></p><p>One thing to be aware of: if you have intensive unit tests and your hudson server isn't very powerful, you simply may not have the capacity to run multiple tests at the same time. I had to spin up some worker VMs on other machines around the house to serve as Hudson slave nodes. Our unit tests were actually taking LONGER when we tried to run them in parallel because of the strain of compiling native extension gems and actually running the tests.</p><p><strong><span style="font-size: large;">Optional profit! step</span></strong></p><p>Code coverage is important. However it makes NO sense to run code coverage tasks on EVERY VM permutation. You only need to run it once (unless you have some VM dependent code in your application). What I've done is take advantage of "Post build actions" to kick off a second job I've defined. This job does nothing but runs our code coverage rake tasks. Steps 1 and 3 are the same as above without the rubyvm variable. Step 2 is different:</p><p><p><span style="font-family: 'andale mono', times;">#!/bin/bash -l</span></p><p><span style="font-family: 'andale mono', times;">rvm use 1.8.7@padrino-rcov-$rubyvm-$BUILD_NUMBER</span></p><p><span style="font-family: 'andale mono', times;">bundle exec rake hudson:coverage:clean</span></p><p><span style="font-family: 'andale mono', times;">bundle exec rake hudson:coverage:unit</span></p><p>We've broken the coverage tests into a unique rake task so they don't impact normal testing. This creates a code coverage report that's visible in Hudson under that project's page. Currently we don't run the coverage report job unless the primary job finishes.</p><p><strong><span style="font-size: large;">Wrap up</span></strong></p><p>That's pretty much it in a nutshell. I'm looking to move Hudson to a more powerful VM here at the house as soon as the hardware comes in. I should be able to then run all the tests across all VMs at one time. Screenshots for each of the steps described in this post are available <a href="http://picasaweb.google.com/lusisjv/RVMAndHudsonRubyBuildMatrix?feat=directlink" target="_blank">here</a></p></p></p></p></p><p>&nbsp;</p><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/934985301455705990-8644466944635794457?l=lusislog.blogspot.com' alt='' /></div>
