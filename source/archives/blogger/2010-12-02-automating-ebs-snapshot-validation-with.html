--- 
name: automating-ebs-snapshot-validation-with
layout: post
title: Automating EBS Snapshot validation with @fog - Part 1
time: 2010-12-02 01:35:00 -05:00
---
<p><strong><span style="font-size: x-large;">Background</span></strong></p><p>One thing that's very exciting about the new company is that I'm getting to use quite a bit of Ruby and also the fact that we're entirely hosted on Amazon Web Services. We currently leverage EBS, ELB, EC2 S3 and CloudFront for our environment. The last time I used AWS in a professional setting, they didn't even have Elastic IPs much less EBS with snapshots and all the nice stuff that makes it viable for a production environment. I did, however, manage to keep abreast of changes using my own personal AWS account.</p><p><strong><span style="font-size: large;">Fog</span></strong></p><p>Of course the combination of Ruby and AWS really means one thing - Fog. And lot's of it.</p><p>When EngineYard announced the sponsorship of the project, I dove headlong into the code base and spent what time I could trying to contribute code back. The half-assed GoGrid code in there right now? Sadly, some of it is mine. Time is hard to come by these days. Regardless, I'm no stranger to Fog and when I had to dive into the environment and start getting it documented and automated, Fog was the first tool I pulled out and when the challenge of verifying our EBS snapshots (of which we're currently at a little over 700), I had no choice but to automate it.</p><p><strong><span style="font-size: large;">Environment</span></strong></p><p>A little bit about the environment:</p><ul><li>- A total of 9 EBS volumes are snapshotted each day</li><li>- 8 of the EBS volumes are actually raid0 mysql data stores across two DB servers (so 4 disks on one/4 disks on another)</li><li>- The remaining EBS volume is a single mysql data volume</li><li>- Filesystem is XFS and backups are done using the Aleastic ec2-consistent-snapshot script (which currently doesn't support tags)</li></ul><p>The end result of this is to establish a rolling set of validated snapshots. 7 daily, 3 weekly, 2 monthly. Fun!</p><p><strong><span style="font-size: large;">Mapping It Out</span></strong></p><p>Here was the attack plan I came up with:</p><ul><li>- Identify snapshots and groupings where appropriate (raid0, remember?)</li><li>- create volumes from snapshots</li><li>- create an m1.xlarge EC2 instance to test the snapshots</li><li>- attach volume groups to the test instance</li><li>- assemble the array on the test instance</li><li>- start MySQL using the snapshotted data directory</li><li>- run some validation queries using some timestamp columns in our schema</li><li>- stop MySQL, unmount volume, stop the array</li><li>- detach and destroy the volumes from the test instance</li><li>- tag the snapshots as "verified"</li><li>- roll off any old snapshots based on retention policy</li><li>- automate all of the above!</li></ul><p>I've got lots of code samples and screenshots so I'm breaking this up into multiple posts. Hopefully part 2 will be up some time tomorrow</p><p> </p><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/934985301455705990-2529391805013577118?l=lusislog.blogspot.com' alt='' /></div>
