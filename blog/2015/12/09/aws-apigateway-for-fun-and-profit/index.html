<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><title>Aws Apigateway for Fun and Profit | blog.lusis.org</title><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff3db4><meta name=theme-color content="#ffffff"><link rel=stylesheet href=https://blog.lusis.org/css/main.min.e34415025514319010e741089e6920454053855755ba465f66943ad102d2cb08.css></head><body><nav><header><div class=site-title><a href=/>blog.lusis.org</a></div></header><div class=nav-menu><a class="color-link nav-link" href=https://blog.lusis.org/index.xml target=_blank rel=noopener type=application/rss+xml>RSS</a></div><footer class=footer><div class=social-icons></div><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p><script src=https://blog.lusis.org/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></nav><div id=content class=content-container><h1 class=post-title>Aws Apigateway for Fun and Profit</h1><time>December 9, 2015</time><div><p><p>At we&rsquo;re currently in the process of reconfiguring our monitoring, logging and alerting setup.</p><p>Obviously this is something near and dear to my heart. At my previous employer we did everything in house due to various constraints.
I&rsquo;ve got a rich set of experiences in this space so my first inclination was to build not buy. However, due to OTHER constraints, building was not a practical solution at present.</p><p>After much research and evaluation, we finally settled on the following stack:</p><ul><li>Loggly</li><li>SignalFx</li><li>OpsGenie</li></ul><p>I&rsquo;m not going into reasons for switching in this post or details about WHY these providers were chosen. This is to discuss a specific AWS service and how it can really change the nature of ChatOps and more.</p><h1 id=integration>Integration</h1><p>Our monitoring and metrics provider, SignalFx, is still building out its integrations.
They have a rich set already and are iterating very quickly but coupled with the migration to OpsGenie, we needed to work out a solution for wiring the two together.
Using the power of google, I came across a great post from <a href=https://twitter.com/ripienaar>R.I. Pienaar</a> about leveraging <a href=https://www.devco.net/archives/2015/08/13/translating-webhooks-with-aws-api-gateway-and-lambda.php>Lambda and the AWS API Gateway products</a>.</p><p>In his post, he didn&rsquo;t really go over the API Gateway configuration so I figured I would document what I &ldquo;figured out&rdquo; for others.</p><h2 id=the-flow>The flow</h2><p>The above post covers most of it but the general idea is:</p><ul><li><a href=https://support.signalfx.com/hc/en-us/articles/203824569-Detectors-and-alerts>SignalFx Alerting</a> webhook fires</li><li>AWS API Gateway gets webhook and fires off a Lambda task</li><li>Lambda task translates webhook into OpsGenie <a href=https://www.opsgenie.com/docs/web-api/alert-api>create alert</a> api call</li><li>OpsGenie wakes you from a dead sleep</li></ul><p>Now you might wonder why go through all this hassle? OpsGenie can create email integrations and SignalFx can send alerts to email address.</p><h1 id=its-about-context>It&rsquo;s about context.</h1><p>When email alerts come in to OpsGenie, they&rsquo;re just &ldquo;pings&rdquo;:
{% blockquote %}
Hey this thing sent us an email and here&rsquo;s the subject. Log in to the website to see the body
{% endblockquote %}</p><p>Frankly there&rsquo;s not much else they can do. SignalFx will also send another email when an alert auto-clears but to OpsGenie, that&rsquo;s another &ldquo;ping&rdquo;. It&rsquo;s unrelated to the previous email.</p><p><img src=/images/posts/apigateway-lambda/hipchat-emails.png alt="Hipchat alerts from OpsGenie"></p><p>As you can see above this could get painful and I already have issues with &ldquo;alert fatigue&rdquo;.</p><p>Additional, even if you <strong>DID</strong> log into the OpsGenie website to look at the details, there&rsquo;s really not much there:</p><p><img src=/images/posts/apigateway-lambda/opsgenie-emails.png alt="Emails in OpsGenie"></p><p>Yeah that&rsquo;s helpful&mldr;</p><p>So we need to accomplish two things:</p><ul><li>Correlate alerts and auto-closes from SignalFx</li><li>Get some damn context into the alert so we can act intelligently on it</li></ul><p>The end result, gives us this:</p><p><img src=/images/posts/apigateway-lambda/webhook-hipchat.png alt="Hipchat alerts from OpsGenie">
<img src=/images/posts/apigateway-lambda/signalfx-context-1.png alt="SignalFx Metadata in OpsGenie">
<img src=/images/posts/apigateway-lambda/opsgenie-alert-history.png alt="OpsGenie Alert History"></p><p>and that&rsquo;s MUCH more useful.</p><h1 id=how-we-did-it>How we did it</h1><p>AWS API Gateway is a PRETTY intimidating thing. There&rsquo;s lots of very specific terminology and frankly I found the docs not so useful.
The general idea is this:</p><ul><li>Create an api</li><li>Create a &ldquo;resource&rdquo; this is just a route that the api gateway responds to i.e. <code>/signalfx_to_loggly</code> via <code>POST</code></li><li>Create a &ldquo;model&rdquo;: This is a json schema that describes what the incoming <code>POST</code> body looks like and its content type</li><li>Create an &ldquo;integration request&rdquo;: What do you do when you get it? In this case call a Lambda task</li></ul><p>There are also concepts like &ldquo;stages&rdquo; which frankly were a bit useless in my case.
In the end, after you get all of this wired up, you&rsquo;ll be given a url that looks something like this:</p><p><code>https://&lt;random id>.execute-api.&lt;region>.amazonaws.com/&lt;stage name>/&lt;resource name></code></p><p>and that&rsquo;s your webhook url.</p><h2 id=models>Models</h2><p>In the case of SignalFx, a webhook post looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;incidentId&#34;</span>:<span style=color:#e6db74>&#34;XXXXXXX&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;detectorUrl&#34;</span>:<span style=color:#e6db74>&#34;https://app.signalfx.com/#/detector/XXXXXXX/edit&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;status&#34;</span>:<span style=color:#e6db74>&#34;too high&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;rule&#34;</span>:<span style=color:#e6db74>&#34;500 errors over 10&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;severity&#34;</span>:<span style=color:#e6db74>&#34;Major&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;eventType&#34;</span>:<span style=color:#e6db74>&#34;_SF_PLOT_KEY_XXXXXXX_3_17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;currentValue&#34;</span>:<span style=color:#e6db74>&#34;2&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;sources&#34;</span>:<span style=color:#e6db74>&#34;chef-external-elb&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;detector&#34;</span>:<span style=color:#e6db74>&#34;ELB 5xx Detector&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>which translates to the following model:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;$schema&#34;</span>: <span style=color:#e6db74>&#34;http://json-schema.org/draft-04/schema#&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;signalfx-webhook-model&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;incidentId&#34;</span>: {<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;detectorUrl&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;status&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;rule&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;severity&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;eventType&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;currentValue&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;sources&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;detector&#34;</span>:{<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;string&#34;</span>}
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=the-lambda-function>The lambda function</h1><p>I&rsquo;m still cleaning up the banged out code for the Lambda function to post on github however here&rsquo;s the relevant bits from the <code>opsgenie.js</code> file I added to <a href=https://github.com/ripienaar/lambda_webhook_gwy>R.I.&rsquo;s code</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>  <span style=color:#a6e22e>sfxNotification</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>config</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>apiKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>api_key</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>alias</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>incidentId</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>note</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>detectorUrl</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Alert: &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>rule</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34; (&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>detector</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;)&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>description</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Current value
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		details: event,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Tags = [&#34;</span><span style=color:#e6db74>`ok`</span><span style=color:#e6db74>&#34;, &#34;</span><span style=color:#e6db74>`too high`</span><span style=color:#e6db74>&#34;, &#34;</span><span style=color:#e6db74>`too low`</span><span style=color:#e6db74>&#34;, &#34;</span><span style=color:#e6db74>`anomalous`</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span></code></pre></div></p></div><div class=page-footer></div></div><footer class=footer-mobile><div class=social-icons></div><div class=footer-mobile-links><p><a href=https://github.com/kimcc/hugo-theme-noteworthy target=_blank rel=noopener>Noteworthy theme</a></p><span class=divider-bar>|</span><p><a href=https://gohugo.io target=_blank rel=noopener>Built with Hugo</a></p></div><script src=https://blog.lusis.org/js/main.min.a7205ef73b078c8daed6fe1b0826e8ba229ffabbb69d299d9446cf41f2c7d8aa.js integrity="sha256-pyBe9zsHjI2u1v4bCCbouiKf+ru2nSmdlEbPQfLH2Ko=" crossorigin=anonymous></script></footer></body></html>